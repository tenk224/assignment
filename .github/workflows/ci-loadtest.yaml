env:
  KUBECONFIG: /root/.kube/config

on:
  push:
    branches:
      - 'feature/**'

jobs:
  ci-loadtest:
    runs-on: self-hosted
    steps:
      - name: checkout
        uses: actions/checkout@main
      - name: create cluster
        run: kind create cluster --config kind/cluster.yaml --name $GITHUB_JOB-$GITHUB_RUN_NUMBER
      - name: validate cluster
        run: kubectl version
      - name: install ingress-nginx
        run: helm install ingress-nginx charts/ingress-nginx -f manifests/ingress-nginx.yaml
      - name: validate ingress-nginx
        run: |
          counter=100
          while [[ $counter >= 0 ]]
          do
            kubectl get daemonset ingress-nginx-controller -o=jsonpath='{.status.numberReady}'
            kubectl get daemonset ingress-nginx-controller -o=jsonpath='{.status.desiredNumberScheduled}'
            echo "\n"
            ((counter-=1))
            sleep 1
          done
      - name: clean up
        if: always()
        run: kind delete cluster --name $GITHUB_JOB-$GITHUB_RUN_NUMBER
